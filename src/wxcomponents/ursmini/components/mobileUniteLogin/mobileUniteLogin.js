const util=require("../util/util").util;var pageBase=require("../base/pageBase");const mbreg=/^86-(13|14|15|16|17|18|19)\d{9}$/;var REGMAP={mobile:mbreg,sms:/^\d{6}$/,agree:/1/};var ERRORMAP={mobile:{empty:"请输入手机号码",invalid:"手机号格式错误",invalid2:"手机号码格式错误，请更换后重试",invalid11:"请输入11位手机号码"},sms:{empty:"请输入短信验证码",invalid:"短信验证码格式错误"},agree:{invalid:"请先同意相关条款"}};const PREFIX="l_yd_s_";const CHECKFORMLIST=["mobile","sms"];const URLMAP={4:"/dl/wx/yd/vftcp",5:"/dl/wx/yd/vfccp",6:"/dl/wx/yd/vfscp"};Component({behaviors:[pageBase],properties:{saveTempMobile:{type:String,value:""},saveTempMobileNm:{type:String,value:""}},data:{changeColor:"",mobile:"",sms:"",haveSMSlogin:true,channel:102,imgBaseUrl:"/dl/wx/yd/cp?",imgUn:"",isnewsmsup:false,noloading:false,uptxt:"",upnum:"",smsbtntxt:"获取验证码"},lifetimes:{detached:function(){this.clearSto()}},detached:function(){this.clearSto()},methods:{onBacksmsdown:function(){this.setData({isnewsmsup:false,noloading:false});this.clearRequest();this.selectComponent("#mobile").onclear()},onGetUn:function(){this.setData({imgUn:this.getMobileValue()})},onMobileChange:function(e){if(e.detail.mobile!=this.data.mobile){this.selectComponent("#sms").onClearUpload()}},onLogin:function(e){this.setData({focus:true});this.checkForm();if(!this.data.errorNode){this.clearError();this.doLogin()}},doVerifyUpSms:function(){this.setData({noloading:true});this.doLogin()},doLogin:function(){if(!this.checkInitOk()){return}this.setData({capValue:""});this.requestProxy({noloading:this.data.noloading,url:"/dl/wx/yd/gt",method:"GET",data:{pd:this.data.pd,pkid:this.data.pkid,pkht:this.data.pkht,channel:this.data.channel,id:wx.getStorageSync(this.data.sidkey),un:this.getMobileValue()},success:this.gtSuccess.bind(this),fail:this.gtFail.bind(this)})},gtSuccess:function(res){let data={pd:this.data.pd,pkid:this.data.pkid,pkht:this.data.pkht,channel:this.data.channel,id:wx.getStorageSync(this.data.sidkey),un:this.getMobileValue(),tk:res.tk};if(!this.data.isnewsmsup){data.sms=this.data.sms}this.requestProxy({noloading:this.data.noloading,url:"/dl/wx/yd/lregvfsms",method:"POST",data:data,success:this.loginSuccess.bind(this),fail:this.loginFail.bind(this)})},loginFail:function(res){if(this.resetNoloading){this.resetNoloading()}if(this.data.isnewsmsup&&res.ret==="415"){this.onBacksmsdown&&this.onBacksmsdown()}this.showError(res)},gtFail:function(res){this.resetNoloading();this.showError(res)},resetNoloading:function(){if(this.data.isnewsmsup){this.selectComponent("#smsup")&&this.selectComponent("#smsup").resetBtn();this.setData({noloading:false})}},onAreaChange:function(e){if(e.detail.area!="86"){this.REGMAP.mobile=/^\d{3,19}$/}else{this.REGMAP.mobile=mbreg}},onShowConfirm:function(e){let popContent=e.detail.popContent;this.setData({needConfirm:true,alertShow:true,warnShow:false,alertInfo:popContent,alertTxt:"知道了"})},_checkMobile:function(){let comp=this.selectComponent("#mobile");let val=comp.getValue();let val2=val.replace("-","");let valnoprefix=val.split("-")[1]||"";let i="mobile";let ername="username";comp.changeMobileReg();let tempobj={};if(val===""||valnoprefix===""){this.setData({nodes:this.ERRORMAP[i].empty,errorNode:ername+"-err"});return false}else if(val.indexOf("86-")!==0){if(valnoprefix.indexOf("000")===0||!this.REGMAP[i].test(val2)){let errText=this.ERRORMAP[i].invalid2;this.setData({nodes:errText,errorNode:ername+"-err"});return false}else{tempobj[i]=val;this.setData(tempobj);return true}}else if(!this.REGMAP[i].test(val)){let errText=this.ERRORMAP[i].invalid;if(val.indexOf("86-")===0&&valnoprefix.length!=11){errText=this.ERRORMAP[i].invalid11}this.setData({nodes:errText,errorNode:ername+"-err"});return false}else{tempobj[i]=val;this.setData(tempobj);return true}},onShowCap:function(){if(this.checkFail5AndClearVf2()){return}if(this._checkMobile()){if(!this.checkInitOk()){return}if(this.capFlag){if(this.capFlag===6){if(this.__checkNoAiCapId()){return}if(!this.aiInitOk){this.lockPage()}this.doAiNext()}else{this.tryShowCap()}}else{this.doSendSms()}}},sendSmsSuccess:function(){this.capFlag=0;this.setData({capFlag:this.capFlag});this.selectComponent("#sms").onCountDown()},sendSmsFail:function(res){let capFlag=this.getCapFlag(res);this.capFlag=capFlag;if(res.ret==="447"){this.tryShowCap(true)}else if(res.ret==="441"||res.ret==="444"||res.ret==="445"){this.tryShowCap()}else if(capFlag>0){if(this.capFlag===6){this.tryShowCap()}}this.showError(res)},doSendSms:function(){this.requestProxy({url:"/dl/wx/yd/lregssms",method:"GET",data:{pd:this.data.pd,pkid:this.data.pkid,pkht:this.data.pkht,channel:this.data.channel,id:wx.getStorageSync(this.data.sidkey),un:this.getMobileValue()},success:this.sendSmsSuccess.bind(this),fail:this.sendSmsFail.bind(this)})},onCanReSend:function(e){this.setData({capValue:""})},getVfData:function(data){data.un=this.getMobileValue();return data},getVfUrl:function(){let capFlag=this.data.capFlag;let url=URLMAP[capFlag]||"/dl/wx/yd/vfcp";return url},onCapSuccess:function(){this.capFlag=0;this.setData({capValue:this.cap,capFlag:this.capFlag});this.doSendSms()},onConfirmOk:function(e){this.setData({needConfirm:false})},onConfirmClose:function(e){this.setData({needConfirm:false})},onRedirectTo:function(){let mobile=this.selectComponent("#mobile").getValue();let nm=this.selectComponent("#mobile").getNm();this.triggerEvent("changepage",{showUnite:false,saveTempMobile:mobile,saveTempMobileNm:nm},{})}},ready:function(){if(this.data.options.noMobilePwdLogin!=="1"){this.setData({pwdLoginUrl:1,pwdOptions:this.data.options})}this.formatOptions(PREFIX);if(!this.data.saveTempMobile&&this.data.preMobile){this.setPreMobile()}else if(this.data.options.noMobilePwdLogin!=="1"){this.setTempMobile()}this.CHECKFORMLIST=CHECKFORMLIST;this.ERRORMAP=ERRORMAP;this.REGMAP=REGMAP;if(this.data.options.changeColor){this.setData({changeColor:"color:"+this.data.options.changeColor})}let data={pd:this.data.pd,pkid:this.data.pkid,pkht:this.data.pkht,channel:this.data.channel};let id=wx.getStorageSync(this.data.sidkey);if(id){data.id=id}util.setBtnTxt(this.data.smsbtntxt,"mbunitelogin");util.clearFail5("mbunitelogin");this.requestProxy({isInit:1,url:"/dl/wx/yd/ini",data:data,success:this.initSuccess.bind(this),fail:this.initFail.bind(this)})}});