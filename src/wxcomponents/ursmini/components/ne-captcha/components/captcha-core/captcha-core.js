require("./../../runtime"),require("./../../common"),(wx.webpackJsonp=wx.webpackJsonp||[]).push([[3],{19:function(t,a,e){"use strict";var i,s,n=Object.assign||function(t){for(var a=1;a<arguments.length;a++){var e=arguments[a];for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])}return t},r=T(e(1)),o=e(0),c=e(2),h=T(c),u=T(e(10)),d=T(e(6)),f=T(e(5)),l=T(e(11)),p=e(4);function T(t){return t&&t.__esModule?t:{default:t}}function E(t){return function(){var a=t.apply(this,arguments);return new Promise(function(t,e){return function i(s,n){try{var r=a[s](n),o=r.value}catch(t){return void e(t)}if(!r.done)return Promise.resolve(o).then(function(t){i("next",t)},function(t){i("throw",t)});t(o)}("next")})}}Component({behaviors:[f.default],properties:{visible:{type:Boolean,value:!1,observer:function(t,a){t!==a&&this.toggleVisible(t)}}},data:{CAPTCHA_TYPE:o.CAPTCHA_TYPE,VERIFY_STATUS:o.VERIFY_STATUS,minWidth:o.WIDTH_RANGE[0],modalAnimationData:{},maskOpacity:0,popupVisible:!1,captchaType:"",loadInfo:{status:"aaa",data:null},countsOfVerifyError:0,verifyStatus:"",captchaTip:"",theme:"",width:0,isReady:!1,isFromInit:!1,widthIsNotAuto:!1,popWidth:""},created:function(){var t=wx.createAnimation();this.modalAnimation=t},attached:function(){var t=this;this.initData(),this.setData({isFromInit:!0}),this.triggerEvent("init"),this.unsubscribeStore=this.store.subscribe(function(a,e){"UPDATE_TYPE"===a.type&&t.setData({captchaType:e.captchaType})})},detached:function(){this.unsubscribeStore()},methods:{initData:function(){var t=this.store.state,a=t.config,e=t.customStyles,i=t.$fetch;if(!a)throw new h.default(c.CONFIG_ERROR,"[core] config must not be null");var s=a.theme,n="auto"!==e.width;this.setData({config:a,theme:s,customStyles:e,widthIsNotAuto:n,popWidth:n?e.width+"px":"auto"}),this.$fetch=i},toggleVisible:function(t){var a=this;if(t)this.setData({popupVisible:t}),!this.data.isFromInit&&this.store.state.token||this.reset(),setTimeout(function(){a.modalAnimation.opacity(1).translateY(0).step({duration:300,timingFunction:"linear"}),a.setData({modalAnimationData:a.modalAnimation.export(),maskOpacity:.3})},30);else{this.modalAnimation.opacity(0).translateY(-40).step({duration:200,timingFunction:"ease-out"}),this.setData({modalAnimationData:this.modalAnimation.export(),maskOpacity:0}),setTimeout(function(){a.setData({popupVisible:t}),a.triggerEvent("closed")},200)}},reset:function(){this.setData({loadInfo:{status:"done",data:null},countsOfVerifyError:0,verifyStatus:"",captchaTip:"",isFromInit:!1}),this.refresh()},resetIfNeed:function(){var t=this.data,a=t.countsOfVerifyError,e=t.verifyStatus;a>o.MAX_VERIFICATION&&e===o.VERIFY_STATUS.MAX_ERROR&&this.reset()},refresh:function(){var t={verifyStatus:"",token:this.store.state.token};this.fetchCaptcha(t)},fetchCaptcha:(s=E(r.default.mark(function t(a){var e,i,s,n,f,l,p,T,E,I,v,A,m=this;return r.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=this.data.langPkg,this.setData({verifyStatus:"",loadInfo:{status:"loading",data:null},captchaTip:e.LOADING}),i=this.data.config,s=i.captchaId,n=i.captchaType,f=this.store.state,l=f.drp,p=f.token,T=Object.assign({id:s,https:!0,type:n,version:"1.0.0",drp:l,token:p,dev:o.DEVICE_TYPE.TOUCH,cb:(0,u.default)(),width:this.data.width,runEnv:o.RUNENV},a),E="/api/v2/mp/get",t.prev=6,t.next=9,this.$fetch({url:E,data:T,onTryError:(0,d.default)(this.data.config)});case 9:I=t.sent,v=I.data,this.setData({loadInfo:{status:"loading",data:v}}),this.store.commit("UPDATE_TOKEN",{token:v.token}),this.store.commit("UPDATE_TYPE",{captchaType:v.type}),t.next=21;break;case 16:t.prev=16,t.t0=t.catch(6),A=new h.default(c.REQUEST_API_ERROR,t.t0.message,{url:E}),this.setData({loadInfo:{status:"error",data:null},captchaTip:e.LOAD_FAIL}),this.catchError(A);case 21:this.data.width||this.createSelectorQuery().select(".yidun-captcha__wrap").boundingClientRect(function(t){m.setData({width:t.width})}).exec();case 22:case"end":return t.stop()}},t,this,[[6,16]])})),function(t){return s.apply(this,arguments)}),finishLoad:function(t){var a=t.detail?"error":"done",e=void 0;if(t.detail)e=this.data.langPkg.LOAD_FAIL;else switch(this.store.state.captchaType){case o.CAPTCHA_TYPE.JIGSAW:e=this.data.langPkg.SLIDE_TIP;break;case o.CAPTCHA_TYPE.POINT:case o.CAPTCHA_TYPE.ICON_POINT:e=this.data.langPkg.CLICK_IN_TURN;break;default:e=""}this.setData({loadInfo:n({},this.data.loadInfo,{status:a}),captchaTip:e}),"error"===a&&this.catchError(t.detail),"done"!==a||this.data.isReady||(this.setData({isReady:!0}),this.triggerEvent("ready"))},catchError:function(t){this.triggerEvent("coreerror",t)},onVerifyCaptcha:function(t){var a=this.data.width,e=this.store.state.token,i=t.detail,s=i.data,r=i.type;this.verifyCaptcha(n({token:e,width:a,type:r},s))},verifyCaptcha:(i=E(r.default.mark(function t(a){var e,i,s,n,f,T,E,I,v=this;return r.default.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return this.setData({verifyStatus:o.VERIFY_STATUS.DOING}),e=this.store.state.captchaType,i="/api/v2/mp/check",s=function(t){var s=v.data.countsOfVerifyError+1,n="";s>o.MAX_VERIFICATION?n=v.data.langPkg.VERIFY_OUT_OF_LIMIT:e!==o.CAPTCHA_TYPE.JIGSAW&&(n=v.data.langPkg.VERIFY_ERROR),v.setData({countsOfVerifyError:s,verifyStatus:s>o.MAX_VERIFICATION?o.VERIFY_STATUS.MAX_ERROR:o.VERIFY_STATUS.ERROR,captchaTip:n});var r=null;r=t?new h.default(c.REQUEST_API_ERROR,t.message,{url:i,token:a?a.token:""}):new h.default(c.BUSINESS_ERROR,"Failed to verify captcha.",{url:i}),v.triggerEvent("verify",[r]),s<=o.MAX_VERIFICATION&&setTimeout(function(){v.refresh()},[o.CAPTCHA_TYPE.POINT,o.CAPTCHA_TYPE.ICON_POINT].includes(e)?1200:300)},n=this.data.config.captchaId,f=Object.assign({},{id:n,version:"1.0.0",cb:(0,u.default)(),runEnv:o.RUNENV},a),t.prev=6,t.next=9,this.$fetch({url:i,method:"POST",data:f,onTryError:(0,d.default)(this.data.config,{token:f.token})});case 9:T=t.sent,(E=T.data).result?(this.setData({verifyStatus:o.VERIFY_STATUS.SUCCESS,captchaTip:e===o.CAPTCHA_TYPE.JIGSAW?"":this.data.langPkg.VERIFY_SUCCESS}),I=(0,l.default)((0,p.eypt)(E.validate+"::")),this.triggerEvent("verify",[null,I]),this.closeDialog()):s(),t.next=17;break;case 14:t.prev=14,t.t0=t.catch(6),s(t.t0);case 17:case"end":return t.stop()}},t,this,[[6,14]])})),function(t){return i.apply(this,arguments)}),closeDialog:function(){this.triggerEvent("close")}}})}},[[19,1,0]]]);