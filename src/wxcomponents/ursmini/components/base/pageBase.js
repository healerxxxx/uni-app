const PADDING=118;const util=require("../util/util").util;var requestList=[];const HTTPCODEMAP={"httpcode-1":"网络异常，请稍后再试","httpcode-400":"网络异常，请稍后再试","httpcode-404":"网络异常，请稍后再试","httpcode-500":"系统繁忙，请稍后再试","httpcode-502":"系统繁忙，请稍后再试","httpcode-503":"系统繁忙，请稍后再试","httpcode-4xx":"网络异常，请稍后再试","httpcode-5xx":"系统繁忙，请稍后再试","httpcode-429":"操作过于频繁，请稍后再试"};const CAPFLAGMAP={441:1,444:4,445:5,447:6};module.exports=Behavior({behaviors:[],properties:{screenwidth:{type:Number,value:wx.getSystemInfoSync().windowWidth},screenheight:{type:Number,value:wx.getSystemInfoSync().windowHeight},options:{type:Object,value:""}},data:{isready:false,displayClass:"hidden",host:"https://dl.reg.163.com",ulogo:"https://webzj.netstatic.net/webzj_weixin/wxmblogo.png",initOk:false,inputFocus:false,loading:"loading",nodes:"",errorNode:"",errorNode1:"",errorNode2:"",buttonStyle:"",errColor:"",capValue:"",capFlag:0,redirectUrl:"",detal:0,sidkey:"",canNotInput:false,DEBUG:"",focus:false,capType:"",capApiServer:["c.dun.163yun.com","c.dun.163.com"],mobilereal:"",noAiCapId:false,autoVerify:false},attached:function(){},methods:{initFail:function(res){this.showError(res)},checkInitOk:function(){if(!this.data.initOk){this.__showToast({title:"正在初始化，请稍后再试",icon:"none",duration:1500})}return this.data.initOk},initSuccess:function(res){this.setData({initOk:true});let id=res.id;if(id){wx.setStorage({key:this.data.sidkey,data:id})}let aiCapId=res.capId||"";if(aiCapId){this.setData({aicapkey:aiCapId})}else{this.setData({noAiCapId:true})}this.capFlag=res.capFlag?res.capFlag:0;if(this.capFlag===6){this.tryShowCap()}},getMobileValue:function(){return this.data.mobile.indexOf("86-")===0?this.data.mobile.split("86-")[1]:this.data.mobile},setPreMobile:function(){let values=this.data.preMobile.split("-"),area,nm,mb;if(values.length>1){area=values[0];nm=this.selectComponent("#mobile").selectNm(area);mb=values[1]}else{area="86";nm="CN";mb=values[0]}this.selectComponent("#mobile").setArea({area:area,nm:nm});this.selectComponent("#mobile").setMb({mb:mb})},setTempMobile:function(){if(this.data.saveTempMobile&&this.data.saveTempMobileNm){let values=this.data.saveTempMobile.split("-");let nm=this.data.saveTempMobileNm;let area=values[0]||"";let mb=values[1]||"";if(area){this.selectComponent("#mobile").setArea({area:area,nm:nm})}if(mb){this.selectComponent("#mobile").setMb({mb:mb})}}},formatOptions:function(prefix){let buttonStyle="";let logoStyle="";this.setData({"options.channel":this.data.channel});let options=this.data.options;Object.keys(options).forEach(function(key){if(key!="buttonBgColor"&&key!="buttonColor"){let tempObj={};tempObj[key]=options[key];this.setData(tempObj)}}.bind(this));this.setData({sidkey:prefix+this.data.pd+this.data.pkid});if(options.buttonBgColor){buttonStyle+=";background-color:"+options.buttonBgColor}if(options.buttonColor){buttonStyle+=";color:"+options.buttonColor}if(options.logoWidth){logoStyle+=";width:"+options.logoWidth}if(options.logoHeight){logoStyle+=";height:"+options.logoHeight}this.setData({buttonStyle:buttonStyle,logoStyle:logoStyle,displayClass:"show"});this.setData({imgBaseUrl:this.data.host+this.data.imgBaseUrl,isready:true})},onConfirmClose:function(e){this.setData({needConfirm:false})},onConfirmOk:function(e){this.setData({needConfirm:false})},onPopupEnd:function(opt){this.cap="";let notunlock=opt&&opt.detail&&opt.detail.notUnlock;if(!notunlock){this.unLockPage()}},tryShowCap:function(capChanged){if(this.capFlag){let capType="";if(this.capFlag===4){capType="jigsaw"}if(this.capFlag!==1){if(this.capFlag===6){this.aiInitOk=false;if(capChanged){this.__clearToastTimeout();this.lockPage()}}else{this.__clearToastTimeout();this.lockPage()}}this.setData({capFlag:0});if(this.__checkNoAiCapId()){return true}let wd=this.data.screenwidth-PADDING;if(this.data.screenwidth>this.data.screenheight){wd=wd>260?260:wd}wd+="px";this.setData({autoVerify:capChanged||false,capFlag:this.capFlag,capType:capType,screenwidthForCap:wd});return true}return false},__checkNoAiCapId:function(){if(this.capFlag===6&&this.data.noAiCapId){this.__showToast({title:"系统繁忙，请关闭小程序重试",icon:"none",duration:1500});return true}},__clearToastTimeout:function(){if(this.unLockTimeout){this.unLockTimeout=clearTimeout(this.unLockTimeout)}},__showToast:function(obj){this.__clearToastTimeout();this.unLockPage();wx.showToast(obj)},formatUpnum:function(upnum){var list=[];upnum=upnum.split("");for(var i=0,item;i<upnum.length;i++){if(i!=0&&i%4===0){list.push(" ")}item=upnum[i];list.push(item)}return list.join("")},showError:function(res){if(res.type||res.type===0){switch(res.type){case 0:if(res.ret==="411"){var receiveCodes,uptxt,upnum;if(res.receiveCode){receiveCodes=res.receiveCode.split(",");uptxt=receiveCodes[0];upnum=receiveCodes[1];upnum=this.formatUpnum(upnum)}if(res.dt==="02"&&res.receiveCode){this.setData({mobilereal:this.getMobileValue(),isnewsmsup:true,uptxt:uptxt,upnum:upnum,nodes:""})}else{this.setData({isnewsmsup:false});if(res.receiveCode){res.content=`请用该号码编写短信<span id="code" style="font-weight:bloder;"> ${uptxt} </span>发送到 <span id="number" style="color:blue;">${upnum}</span>`;res.smsUpDep=`为了保证帐号的安全，编写上行短信${uptxt}发送到${upnum}，会收到短信验证码。`}this.selectComponent("#sms").onNeedUpload(res)}}break;case 1:break;case 2:break;case 3:if(res.errArea&&res.errArea.indexOf(",")>=0){let areaList=res.errArea.split(",");this.setData({nodes:res.content||"",errorNode:"1",errorNode1:(areaList[0]||"")+"-err",errorNode2:(areaList[1]||"")+"-err"})}else{this.setData({nodes:res.content||"",errorNode:res.errArea+"-err"})}break;case 4:this.__showToast({title:res.content||"",icon:"none",duration:1500});break;case 5:this.setData({needConfirm:true,alertShow:true,warnShow:false,alertInfo:res.content||"",alertTxt:res.btn1||"知道了"});break;case 6:this.setData({needConfirm:true,alertShow:false,warnShow:true,alertInfo:res.content||"",warnCloseTxt:res.btn1||"取消",warnConfirmTxt:res.btn2||"确定"});break;case 7:this.setData({needConfirm:true,alertShow:false,warnShow:true,alertInfo:res.content||"",warnCloseTxt:res.btn1||"取消",warnConfirmTxt:res.btn2||"确定"});break;default:break}}else{if(res.isHttpCode){return}let ret=res&&res.ret&&res.ret.toString()||"4";if(["441","444","445","447"].indexOf(ret)!==-1){return}if(ret.indexOf("4")===0){this.__showToast({title:"请求异常，请稍后再试",icon:"none",duration:1500})}else if(ret.indexOf("5")===0){this.__showToast({title:"系统内部错误，请稍后再试",icon:"none",duration:1500})}}},capSuccess:function(ajaxCapFlag,res){if(ajaxCapFlag===1){this.selectComponent("#cap"+ajaxCapFlag).onStateSuccess()}else if(ajaxCapFlag===4||ajaxCapFlag===5||ajaxCapFlag===6){this.onCapSuccess()}},getCapFlag:function(res){let code1=res.ret;let code2=res.capFlag;let capFlag=CAPFLAGMAP[code1]||code2||0;return capFlag},resetAiCap:function(){this.cap="";this.selectComponent("#cap6").doReset()},showFail5Err:function(){this.setData({capFlag:0});this.__showToast({title:"验证失败次数过多，请稍后再试",icon:"none",duration:1500})},showVf2ErrTxt:function(){let vf2md=util.getModule();let txt=util.vf2FailTxt();this.setData({nodes:txt,errorNode:vf2md})},capFail:function(ajaxCapFlag,res){if(util.fail5(true)){this.showFail5Err();return}let capFlag=this.getCapFlag(res);if(capFlag===0){capFlag=this.capFlag}this.capFlag=capFlag;if(ajaxCapFlag===this.capFlag){if(this.capFlag===6){if(res.ret==="447"){this.showVf2ErrTxt()}this.resetAiCap()}else if(this.capFlag===1){this.selectComponent("#cap"+this.capFlag).onStateFail()}else if(this.capFlag===4||this.capFlag===5){this.tryShowCap()}}else{this.tryShowCap(true)}this.showError(res)},clearVf2Err:function(target){if(this.data.errorNode===target){this.setData({nodes:"",errorNode:""})}},onCapCheck:function(e){let cap=e.detail.val;let url=this.getVfUrl();let method="POST";this.cap=cap;let data={pd:this.data.pd,pkid:this.data.pkid,pkht:this.data.pkht,channel:this.data.channel,id:wx.getStorageSync(this.data.sidkey),cap:this.cap};if(this.data.capFlag===6){method="GET"}else if(this.data.capFlag===4||this.data.capFlag===5){method="GET";data.capkey=this.data.capkey}data=this.getVfData(data);this.requestProxy({url:url,method:method,header:{"content-type":"application/x-www-form-urlencoded"},data:data,success:this.capSuccess.bind(this,this.data.capFlag),fail:this.capFail.bind(this,this.data.capFlag)})},onCloseCap:function(opt){if(opt&&opt.detail&&opt.detail.isimg){this.setData({capFlag:0})}},onCapSuccess:function(){this.capFlag=0;this.setData({capValue:this.cap,capFlag:this.capFlag});this.doLogin()},loginSuccess:function(res){if(this.resetNoloading){this.resetNoloading()}wx.setStorage({key:"urs_loginToken",data:{val:res.ntes_wx_token||res.ntes_wx_yd_token},success:function(){if(this.data.detal){wx.navigateBack({delta:parseInt(this.data.detal)})}else if(this.data.redirectUrl){wx.navigateTo({url:this.data.redirectUrl})}}.bind(this)})},loginFail:function(res){if(this.resetNoloading){this.resetNoloading()}let capFlag=this.getCapFlag(res);this.capFlag=capFlag;if(res.ret==="447"){this.tryShowCap(true);return}else if(res.ret==="441"||res.ret==="444"||res.ret==="445"){this.tryShowCap()}else if(capFlag>0){if(this.capFlag===6){this.tryShowCap()}}this.showError(res)},checkFail5AndClearVf2:function(){if(util.fail5()){this.showFail5Err();return true}let vf2md=util.getModule();this.clearVf2Err(vf2md);return false},onLogin:function(){this.setData({focus:true});if(this.checkFail5AndClearVf2()){return}this.checkForm();if(!this.data.errorNode){this.clearError();if(this.capFlag){if(this.capFlag===6){if(this.__checkNoAiCapId()){return}if(!this.aiInitOk){this.lockPage()}this.doAiNext()}else{this.tryShowCap()}}else{this.doLogin()}}},onAiInitOk:function(){this.aiInitOk=true},doAiNext:function(lastIndex){var index=lastIndex||0;if(this.aiInitOk&&this.selectComponent("#cap6")){this.selectComponent("#cap6").doVerify()}else{if(this.aisto){clearTimeout(this.aisto)}this.aisto=setTimeout(function(){if(this.aiInitOk&&this.selectComponent("#cap6")){this.selectComponent("#cap6").doVerify()}else{index++;if(index<=31){this.doAiNext(index)}}}.bind(this),200)}},onFirstError:function(){this.unLockPage()},clearError:function(){this.setData({nodes:"",errorNode:"",errorNode1:"",errorNode2:""})},checkForm:function(){this.clearError();for(let k=0,l=this.CHECKFORMLIST.length,i;k<l;k++){i=this.CHECKFORMLIST[k];let comp=this.selectComponent("#"+i);if(i==="mobile"){comp.changeMobileReg()}let val=comp.getValue();let val2=val.replace("-","");let valnoprefix=val.indexOf("-")>-1?val.split("-")[1]||"":val;let tempobj={};tempobj[i]="";let ername=i;if(ername=="mobile"||ername=="email"){ername="username"}if(i==="agree"){if(val==="0"){this.__showToast({title:this.ERRORMAP[i].invalid,icon:"none",duration:1500});this.setData({errorNode:i+"-err"})}}else{if(val===""||i==="mobile"&&valnoprefix===""){this.setData({nodes:this.ERRORMAP[i].empty,errorNode:ername+"-err"});break}else if(i==="mobile"&&val.indexOf("86-")!==0){if(valnoprefix.indexOf("000")===0||!this.REGMAP[i].test(val2)){let errText=this.ERRORMAP[i].invalid2;this.setData({nodes:errText,errorNode:ername+"-err"});break}else{tempobj[i]=val;this.setData(tempobj)}}else if(!this.REGMAP[i].test(val)){let errText=this.ERRORMAP[i].invalid;if(i==="mobile"&&val.indexOf("86-")===0&&valnoprefix.length!=11){errText=this.ERRORMAP[i].invalid11}this.setData({nodes:errText,errorNode:ername+"-err"});break}else{tempobj[i]=val;this.setData(tempobj)}}}},clearSto:function(){if(this.aisto){clearTimeout(this.aisto)}if(this.iptBlurSto){clearTimeout(this.iptBlurSto)}this.__clearToastTimeout()},onInputBlur:function(){this.iptBlurSto=setTimeout(function(){let emailC=this.selectComponent("#email");emailC&&emailC.onInputBlur();let pwdC=this.selectComponent("#password");pwdC&&pwdC.onInputBlur();let mobileC=this.selectComponent("#mobile");mobileC&&mobileC.onInputBlur();let smsC=this.selectComponent("#sms");smsC&&smsC.onInputBlur()}.bind(this),1200)},onFocus:function(e){let from=e.detail.from;if(this.data.errorNode===from){this.setData({nodes:"",errorNode:""})}if(this.data.errorNode1===from||this.data.errorNode2===from){this.clearError()}},unLockPage:function(){this.setData({canNotInput:false});wx.hideToast({})},lockPage:function(){this.setData({canNotInput:true});wx.showToast({title:"",icon:"loading",duration:1e4})},onTap:function(e){if(e.target.id!="mobile"&&e.target.id!="changemodule"){this.selectComponent("#mobile")&&this.selectComponent("#mobile").onHideArea()}},beforeAjaxSuccess:function(res){},beforeAjaxFail:function(res){},clearRequest:function(){if(requestList&&requestList.length>0){requestList.forEach(request=>{request.abort()});requestList=[]}},requestProxy:function(options){let data=options.data||{};let method=options.method||"GET";let header=options.header||{"content-type":"application/json"};if(method.toUpperCase==="GET"){data.nocache=(new Date).getTime()}options.url=this.data.host+options.url;this.__clearToastTimeout();if(options.isInit){this.clearRequest();data.version="wx1.2.3"}else{if(!options.noloading){this.lockPage()}}var req=wx.request({url:options.url,data:data,method:method,header:header,success:function(res){this.unLockTimeout=setTimeout(function(){this.unLockPage()}.bind(this),100);if(res.statusCode===200){let data=res.data;if(data.ret==="201"){this.beforeAjaxSuccess(data);options.success&&options.success(data)}else{this.beforeAjaxFail(data);options.fail&&options.fail(data)}}else{let data={ret:res.statusCode};data.isHttpCode=true;this.beforeAjaxFailHttpCode(data);options.fail&&options.fail(data)}}.bind(this),fail:function(res){if(res.errMsg==="request:fail abort"){return}this.unLockTimeout=setTimeout(function(){this.unLockPage()}.bind(this),100);this.beforeAjaxFail(res);options.fail&&options.fail(res)}.bind(this),complete:function(res){}.bind(this)});requestList.push(req)},getHttpCodeTxt:function(code){code=code+"";let httpcode="httpcode-1";if(["400","404","500","502","503","429"].indexOf(code)>-1){httpcode="httpcode-"+code}else{if(code.indexOf("4")===0){httpcode="httpcode-4xx"}if(code.indexOf("5")===0){httpcode="httpcode-5xx"}}return HTTPCODEMAP[httpcode]},beforeAjaxFailHttpCode:function(data){let code=data.ret;let txt=this.getHttpCodeTxt(code);this.__showToast({title:txt,icon:"none",duration:1500})}}});